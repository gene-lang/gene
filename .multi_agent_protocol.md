# Multi-Agent Collaboration Protocol

## Overview

This protocol enables multiple AI agent instances to collaborate on a single codebase by communicating through shared markdown files. Each agent operates independently in its own session but maintains coordination through a shared conversation log.

## Agent Identity and Initialization

### Startup Sequence

At the start of EVERY session, you MUST follow this sequence:

1. **Request your identity from the user**:
   ```
   To collaborate on this codebase with other agents, I need to know my identity.
   
   Please tell me:
   - My agent name (e.g., "Builder", "Reviewer", "Tester", "Claude", "Codex"...)
   ```

2. **Read the conversation log**: Once you receive your name, read `.multi_agent_conversation.md` to:
   - See what other agents are working on
   - Check for any messages directed at you (@YourName)
   - Understand the current state of the project
   - Identify any pending tasks or questions

   If the file exists and has content, append:
   ```markdown
   [TIMESTAMP] @YourName has joined/resumed the session
   ```
   
   If the file doesn't exist or is empty, create it and add:
   ```markdown
   # Codebase Collaboration Log
   
   [TIMESTAMP] @YourName has started a new collaboration session
   ```
   
3. **Remember your name**: Store your assigned name in memory and use it consistently throughout the entire session.

## File Structure

### .multi_agent_conversation.md
- **Purpose**: Active conversation log with recent, actionable messages
- **Scope**: Current work session (typically last 2-4 hours)
- **Max recommended size**: ~500 lines
- **Format**: Chronological append-only log, add a new line for each message.

### .multi_agent_history.md
- **Purpose**: Archive of older messages for reference
- **Scope**: Historical context from previous work sessions
- **Format**: Chronological append-only log
- **Management**: Only append, never delete unless @user explicitly instructs

## Timestamp Checking Protocol

**CRITICAL**: Before starting any work, you MUST check timestamps to ensure you're working with current information.

### Pre-Work Timestamp Check

Before proceeding with any task:

1. **Read .multi_agent_conversation.md**
2. **Check the timestamp of the most recent message**
3. **Compare with current time**: Note the current date and time (run `date '+%Y-%m-%d %H:%M'` to capture it accurately)
4. **Assess staleness**:
   - Messages < 15 minutes old: Very fresh, proceed confidently
   - Messages 15-60 minutes old: Recent, likely still relevant
   - Messages hours/days old: Check with user before proceeding

5. **If timestamps are stale, ask user**:
   ```
   I see the last message in .multi_agent_conversation.md is from [TIMESTAMP], which was [X hours/minutes] ago.
   
   Before I proceed with [TASK], should I:
   - Continue as planned?
   - Wait for updates from other agents?
   - Check if priorities have changed?
   ```

### Timestamp Format

Always use ISO 8601 format with date and time:
```
[YYYY-MM-DD HH:MM]
```

Examples:
```
[2025-11-10 09:15]
[2025-11-11 16:45]
```

Always compute timestamps with `date '+%Y-%m-%d %H:%M'` before writing to the log so every entry shares a consistent source of truth.

## Communication Protocol

### Message Format

All messages in .multi_agent_conversation.md must follow this format:

```markdown
[TIMESTAMP] @SenderName → @RecipientName: Message content
```

### Message Types

#### Direct Message to Specific Agent
```markdown
[2025-11-10 14:30] @Builder → @Reviewer: Please review the authentication module in src/auth.py
```

#### Broadcast to All Agents
```markdown
[2025-11-10 14:35] @Tester → @all: All unit tests are passing. Ready for integration testing.
```

#### Message to User
```markdown
[2025-11-10 14:40] @Builder → @user: Authentication feature is complete and awaiting your approval.
```

### When to Use Mentions

- **@AgentName**: Direct a message, question, or task to a specific agent
- **@user**: Request human input, approval, or report final results
- **@all**: Broadcast information relevant to all agents (status updates, blockers, milestones)

### Reading Messages

When reading .multi_agent_conversation.md:

1. **Check all messages chronologically**
2. **Prioritize messages mentioning @YourName**
3. **Note any @all broadcasts**
4. **Identify any blockers or questions directed at you**
5. **Understand current work state before starting new tasks**

### Writing Messages

When writing to .multi_agent_conversation.md:

1. **Always include current timestamp**
2. **Always include your @AgentName**
3. **Always specify recipient (@target, @all, or @user)**
4. **Reference specific files, functions, or line numbers when relevant**
5. **Use clear, unambiguous language**

## Conversation History Management

### When to Archive

Archive older messages when:
- .multi_agent_conversation.md exceeds ~500 lines
- A major milestone is completed (e.g., feature fully deployed)
- Natural breakpoint in work (e.g., end of day, major refactor complete)
- User requests archiving

### Archiving Process

1. **Check if archiving is needed**:
   - Count lines in .multi_agent_conversation.md
   - If > 500 lines, proceed to step 2

2. **Request user permission**:
   ```
   .multi_agent_conversation.md has grown to ~XXX lines. Should I archive older messages 
   to .multi_agent_history.md to keep context focused? 
   
   I recommend archiving messages before [SUGGESTED_TIMESTAMP].
   ```

3. **If approved, perform archiving**:
   
   a. Read current conversation
   
   b. Identify logical cutoff point:
      - Messages older than 4 hours, OR
      - Messages before last major milestone, OR
      - User-specified cutoff
   
   c. **Critical: Keep these in .multi_agent_conversation.md**:
      - Unresolved questions or pending tasks
      - Work-in-progress status updates
      - Most recent message from each active agent
      - Any message less than 2 hours old
   
   d. Append archived content to .multi_agent_history.md:
      ```markdown
      
      ## Archived [YYYY-MM-DD HH:MM]
      
      [... archived messages ...]
      ```
   
   e. Remove archived messages from .multi_agent_conversation.md
   
   f. Add archive marker to .multi_agent_conversation.md:
      ```markdown
      [TIMESTAMP] @YourName: Archived messages before [CUTOFF_TIME] to .multi_agent_history.md
      ```

## Collaboration Workflow

### Standard Work Cycle

1. **Initialize**
   - Get your agent name from @user
   - Read .multi_agent_conversation.md
   - Check timestamps

2. **Before Starting Work**
   - Verify timestamps are current
   - Check for pending messages directed at @YourName
   - Announce your intentions:
     ```markdown
     [TIMESTAMP] @YourName → @all: Starting work on [TASK/FEATURE]
     ```

3. **During Work**
   - Document significant progress
   - Coordinate with other agents as needed
   - Respond to @mentions promptly
   - Report blockers immediately

4. **After Completing Work**
   - Mark task as complete
   - Update .multi_agent_conversation.md with results and completion summary
   - Commit all changes (including .multi_agent_conversation.md updates)
   - Notify relevant stakeholders
   ```markdown
   [TIMESTAMP] @YourName → @user: Completed [TASK]. Summary: [BRIEF_SUMMARY]
   ```

### Avoiding Conflicts

To prevent duplicate work or file conflicts:

1. **Announce before editing**:
   ```markdown
   [TIMESTAMP] @Builder → @all: About to modify src/auth.py and src/config.py
   ```

2. **Check for concurrent work**:
   - Read .multi_agent_conversation.md before editing shared files
   - If another agent is working on same file, coordinate first

3. **Coordinate handoffs**:
   ```markdown
   [TIMESTAMP] @Builder → @Reviewer: Finished with src/auth.py. File is yours to review.
   ```

### Requesting Help

When you need another agent's expertise:

```markdown
[TIMESTAMP] @YourName → @OtherAgent: Need help with [SPECIFIC_ISSUE]. 
Context: [BRIEF_CONTEXT]
Files: [RELEVANT_FILES]
```

### Responding to Requests

When another agent requests your help:

1. **Acknowledge the request**:
   ```markdown
   [TIMESTAMP] @YourName → @RequestingAgent: Received your request. Will review [TASK] now.
   ```

2. **Provide your response**:
   ```markdown
   [TIMESTAMP] @YourName → @RequestingAgent: Completed review. Findings:
   - [FINDING_1]
   - [FINDING_2]
   ```

## Best Practices

### Communication

- **Be concise**: Keep messages focused and actionable
- **Be specific**: Reference exact files, line numbers, function names
- **Be timely**: Respond to @mentions within your session
- **Be clear**: Avoid ambiguity in task descriptions or status updates
- **Use timestamps**: Always include current timestamp in every message

### Coordination

- **Read before acting**: Always check .multi_agent_conversation.md before starting work
- **Announce intentions**: Let others know what you're working on
- **Document milestones**: Log significant progress and completions
- **Acknowledge messages**: Confirm receipt of tasks or questions
- **Report blockers**: Immediately communicate obstacles

### Context Management

- **Keep .multi_agent_conversation.md focused**: Only recent, actionable messages
- **Archive regularly**: Offer to archive when file grows large
- **Preserve important info**: Never archive unresolved questions

### Agent Behavior

- **Never assume identity**: Always ask @user for your name
- **No memory between sessions**: Treat each session as fresh start
- **Rely on .multi_agent_conversation.md**: Only source of truth between sessions
- **Verify timestamps**: Check currency of information before acting
- **Coordinate, don't duplicate**: Check what others are doing

## Example Session Flow

```markdown
# .multi_agent_conversation.md

[2025-11-10 09:00] @Builder has started a new collaboration session

[2025-11-10 09:05] @user → @Builder: Please implement user authentication with JWT

[2025-11-10 09:06] @Builder → @all: Starting work on user authentication module

[2025-11-10 09:45] @Builder → @all: Created src/auth.py with JWT implementation

[2025-11-10 10:00] @Builder → @Reviewer: Auth module complete. Please review:
- src/auth.py
- src/models/user.py
- tests/test_auth.py

[2025-11-10 10:15] @Reviewer has joined the session

[2025-11-10 10:20] @Reviewer → @Builder: Reviewing now.

[2025-11-10 10:35] @Reviewer → @Builder: Found issues in auth.py:
- Line 34: Add input validation for email format
- Line 67: JWT secret should come from environment variable
- Line 89: Add rate limiting to login endpoint

[2025-11-10 10:50] @Builder has resumed the session

[2025-11-10 10:52] @Builder → @Reviewer: Noted. Will address all three items.

[2025-11-10 11:15] @Builder → @Reviewer: All issues resolved:
- Added email validation with regex
- Moved JWT_SECRET to .env
- Implemented rate limiting with 5 requests/minute

[2025-11-10 11:30] @Reviewer has resumed the session

[2025-11-10 11:35] @Reviewer → @Builder: Verified all changes. Looks good!

[2025-11-10 11:36] @Reviewer → @user: Authentication module approved. Ready for deployment.

[2025-11-10 11:40] @user → @Tester: Please run integration tests on auth module

[2025-11-10 11:45] @Tester has joined the session

[2025-11-10 11:50] @Tester → @all: Running integration test suite...

[2025-11-10 12:05] @Tester → @user: All tests passing ✓
- Unit tests: 47/47 passed
- Integration tests: 12/12 passed
- Coverage: 94%
```

## Important Reminders

### Session Independence
- Each agent session is completely independent
- You have no memory of previous sessions
- Always ask @user for your identity at session start
- Never assume you're continuing from a previous session

### User Orchestration
- @user decides which agent does what
- @user controls when to switch between agents
- @user has final approval authority
- Follow @user instructions even if they override protocol
- @user may use quick instructions to help you follow protocol:
  - "enter multiagent mode" - Start multi-agent mode and get your identity
  - "check messages" - Look for missed @YourName mentions and @all broadcasts
  - "multiagent protocol update" - Reread protocol file when protocol itself changes
  - "sync up" - Combined activation + message check + coordination

### Protocol Assistance
If you forget to follow the protocol or miss messages:
- @user may remind you with these quick instructions
- Always respond to user instructions promptly
- Reference detailed instructions in `AGENTS.md` if needed
- Don't be defensive - simply follow the protocol when reminded
- These are natural language patterns, not built-in commands

### Shared Context
- .multi_agent_conversation.md is the ONLY shared memory between sessions
- All coordination happens through .multi_agent_conversation.md
- No other mechanism exists for inter-agent communication
- Timestamps are critical for determining information currency

### Timestamp Vigilance
- Always check timestamps before acting on messages
- Stale information (30+ minutes) requires user confirmation
- Include current timestamp in every message you write
- Use ISO 8601 format: [YYYY-MM-DD HH:MM]

### Context Efficiency
- Keep .multi_agent_conversation.md under 500 lines
- Archive older content to .multi_agent_history.md
- Never archive unresolved questions or pending tasks
- Maintain focus on current, actionable work

## Error Handling

### Missing .multi_agent_conversation.md
If .multi_agent_conversation.md doesn't exist:
1. Create it with initialization message
2. Inform @user this is a new collaboration
3. Proceed with assigned task

### Corrupted or Unclear Messages
If you find unclear messages in .multi_agent_conversation.md:
1. Note the problematic message timestamp
2. Ask @user for clarification:
   ```markdown
   [TIMESTAMP] @YourName → @user: Found unclear message at [PROBLEM_TIMESTAMP]. 
   Can you clarify the intent?
   ```

### Conflicting Instructions
If you receive conflicting instructions from different sources:
1. Prioritize @user instructions over other agents
2. Highlight the conflict:
   ```markdown
   [TIMESTAMP] @YourName → @user: Received conflicting instructions:
   - @Agent1 [TIMESTAMP]: [INSTRUCTION_1]
   - @Agent2 [TIMESTAMP]: [INSTRUCTION_2]
   
   Which should I follow?
   ```

### Stale Conversation Log
If all messages are very old (hours/days):
1. Read to understand historical context
2. Ask @user before proceeding:
   ```
   The most recent message in .multi_agent_conversation.md is from [X hours/days] ago.
   Should I proceed with [TASK], or has the situation changed?
   ```

## Protocol Version

**Version**: 1.0  
**Last Updated**: 2025-11-10  
**Maintained By**: @user
