# LLM Functions Module
# Model initialization, prompt building, and inference

(import MODEL_PATH MODEL_CONTEXT from "config")
(import build_system_prompt from "tools")

(fn $ns/init_llm []
  (if (MODEL_PATH/.length == 0)
    (println "No GENE_LLM_MODEL environment variable set - running in mock mode")
  elif genex/llm
    (println "Loading LLM model from:" MODEL_PATH)
    (try
      (var model (genex/llm/load_model MODEL_PATH {^gpu_layers 99 ^context MODEL_CONTEXT}))
      (genex/llm/register_model model)
      (println "LLM model loaded and registered successfully")
    catch *
      (println #"Failed to load model: #{$ex/message} - running in mock mode")
      (println "Place a GGUF model file at the specified path to enable LLM inference")
    )
  else
    (println "GENE_LLM_MODEL is set, but genex/llm is unavailable. Rebuild with -d:geneLLM.")
  )
)

(fn $ns/build_prompt [history message]
  (var parts [])
  (var system_prompt (build_system_prompt))
  (parts .append #"<|im_start|>system\n#{system_prompt}\n<|im_end|>\n")
  (history .each (fn [entry]
    (case entry/role
    when "user"
      (parts .append #"<|im_start|>user\n#{entry/content}\n<|im_end|>\n")
    when "assistant"
      (parts .append #"<|im_start|>assistant\n#{entry/content}\n<|im_end|>\n")
    when "tool_result"
      (parts .append #"<|im_start|>user\nTool result: #{entry/content}\n<|im_end|>\n")
    )
  ))
  (if (message/.length > 0)
    (parts .append #"<|im_start|>user\n#{message}\n<|im_end|>\n<|im_start|>assistant\n")
  else
    (parts .append "<|im_start|>assistant\n")
  )
  (parts .join "")
)

(fn $ns/trim_history [history max_items]
  (if (history/.size <= max_items)
    (return history)
  )
  (var trimmed [])
  (var start (history/.size - max_items))
  (var i start)
  (loop
    (if (i >= history/.size)
      (break)
    )
    (trimmed .append (history .get i))
    (i += 1)
  )
  trimmed
)

(fn $ns/trim_history_for_prompt [history message max_items max_chars]
  (var trimmed (trim_history history max_items))
  (if (max_chars <= 0)
    (return trimmed)
  )
  (var prompt (build_prompt trimmed message))
  (loop
    (if (prompt/.length <= max_chars)
      (break)
    )
    (if (trimmed/.size <= 1)
      (break)
    )
    (trimmed = (trim_history trimmed (trimmed/.size - 1)))
    (prompt = (build_prompt trimmed message))
  )
  trimmed
)

(fn $ns/get_model []
  (if genex/llm then (genex/llm/get_model) else false)
)
