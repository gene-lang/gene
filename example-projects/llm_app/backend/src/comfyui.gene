# ComfyUI Integration Module
# Provides functions to interact with ComfyUI API for image generation

(import COMFYUI_URL from "config")

# Use curl for HTTP requests to work around macOS Local Network permission issue
(fn curl_get [url]
  (var cmd #"curl -s --connect-timeout 10 '#{url}'")
  (var result (system/shell cmd))
  (if (result/exit_code != 0)
    (throw #"HTTP GET failed: #{result/output}")
  )
  result/output
)

(fn curl_post [url body]
  # Escape single quotes in the body for shell safety
  (var escaped_body (body .replace "'" "'\\''"))
  (var cmd #"printf '%s' '#{escaped_body}' | curl -s --connect-timeout 30 -X POST -H 'Content-Type: application/json' --data-binary @- '#{url}'")
  (var result (system/shell cmd))
  (if (result/exit_code != 0)
    (throw #"HTTP POST failed (code #{result/exit_code}): #{result/output}")
  )
  result/output
)

# Generate a unique client ID
(fn generate_client_id []
  # Use random_int (max min) to generate a random 6-digit number
  (var rand_part (random_int 999999 100000))
  #"gene-client-#{rand_part}"
)

# Helper to safely get from map with default
(fn safe_get [obj key default_val]
  (try
    (if (obj .contains key)
      (obj .get key default_val)
    else
      default_val
    )
  catch *
    default_val
  )
)

# Default workflow template for text-to-image
# This is a minimal SDXL workflow - users can customize via parameters
(fn build_workflow [prompt options]
  (var opts (if (options == nil) then {} else options))

  # Extract options with defaults
  (var negative_prompt (if (opts .contains "negative_prompt") then (opts .get "negative_prompt") else ""))
  (var width (if (opts .contains "width") then (opts .get "width") else 1024))
  (var height (if (opts .contains "height") then (opts .get "height") else 1024))
  (var steps (if (opts .contains "steps") then (opts .get "steps") else 20))
  (var cfg (if (opts .contains "cfg") then (opts .get "cfg") else 7.0))
  (var seed (if (opts .contains "seed") then (opts .get "seed") else (random_int 2147483647)))
  (var model (if (opts .contains "model") then (opts .get "model") else "juggernautXL_v9.safetensors"))
  (var sampler (if (opts .contains "sampler") then (opts .get "sampler") else "euler"))
  (var scheduler (if (opts .contains "scheduler") then (opts .get "scheduler") else "normal"))

  # ComfyUI workflow format - minimal SDXL workflow
  {
    ^3 {
      ^class_type "KSampler"
      ^inputs {
        ^cfg cfg
        ^denoise 1
        ^latent_image ["5" 0]
        ^model ["4" 0]
        ^negative ["7" 0]
        ^positive ["6" 0]
        ^sampler_name sampler
        ^scheduler scheduler
        ^seed seed
        ^steps steps
      }
    }
    ^4 {
      ^class_type "CheckpointLoaderSimple"
      ^inputs {
        ^ckpt_name model
      }
    }
    ^5 {
      ^class_type "EmptyLatentImage"
      ^inputs {
        ^batch_size 1
        ^height height
        ^width width
      }
    }
    ^6 {
      ^class_type "CLIPTextEncode"
      ^inputs {
        ^clip ["4" 1]
        ^text prompt
      }
    }
    ^7 {
      ^class_type "CLIPTextEncode"
      ^inputs {
        ^clip ["4" 1]
        ^text negative_prompt
      }
    }
    ^8 {
      ^class_type "VAEDecode"
      ^inputs {
        ^samples ["3" 0]
        ^vae ["4" 2]
      }
    }
    ^9 {
      ^class_type "SaveImage"
      ^inputs {
        ^filename_prefix "ComfyUI"
        ^images ["8" 0]
      }
    }
  }
)

# Queue a prompt to ComfyUI
(fn queue_prompt [workflow]
  (var client_id (generate_client_id))
  (var url #"#{COMFYUI_URL}/prompt")
  (var payload {^prompt workflow ^client_id client_id})

  (var resp_body (curl_post url payload/.to_json))
  (var result (gene/json/parse resp_body))
  (if (result .contains "error")
    (var err_obj (result .get "error"))
    (var err_msg (if (err_obj .contains "message") then (err_obj .get "message") else "unknown error"))
    (throw #"ComfyUI error: #{err_msg}")
  )

  {
    ^prompt_id (safe_get result "prompt_id" "")
    ^client_id client_id
  }
)

# Check if a prompt has completed
(fn get_history [prompt_id]
  (var url #"#{COMFYUI_URL}/history/#{prompt_id}")
  (try
    (var resp_body (curl_get url))
    (gene/json/parse resp_body)
  catch *
    nil
  )
)

# Poll for completion with timeout
(fn wait_for_completion [prompt_id timeout_ms]
  (var poll_interval 500)  # ms
  (var max_iterations (timeout_ms / poll_interval))
  (var iteration 0)

  (loop
    (if (iteration >= max_iterations)
      (throw "ComfyUI generation timed out")
    )

    (var history (get_history prompt_id))

    (if (history != nil)
      (try
        (if (history .contains prompt_id)
          (var prompt_data (history .get prompt_id))
          (if (prompt_data != nil)
            (if (prompt_data .contains "outputs")
              (return prompt_data)
            )
          )
        )
      catch *
        nil
      )
    )

    (iteration = (iteration + 1))
    (sleep poll_interval)
  )
)

# Get image data from ComfyUI (binary-safe using temp file)
# Returns path to temp file and content type - caller should serve file and delete it
(fn $ns/get_image_path [filename subfolder type]
  (var url #"#{COMFYUI_URL}/view?filename=#{filename}&subfolder=#{subfolder}&type=#{type}")
  (var tmp_file #"/tmp/comfyui_img_#{(random_int 999999)}.png")
  (var cmd #"curl -s --connect-timeout 10 -o '#{tmp_file}' '#{url}'")
  (var result (system/shell cmd))
  (if (result/exit_code != 0)
    (throw #"HTTP GET failed: #{result/output}")
  )
  {
    ^path tmp_file
    ^content_type "image/png"
  }
)

# Main function to generate an image
(fn $ns/generate_image [prompt options]
  (var opts (if (options == nil) then {} else options))
  (var workflow (build_workflow prompt opts))
  (var queue_result (queue_prompt workflow))
  (var prompt_id queue_result/prompt_id)

  (var timeout (safe_get opts "timeout" 120000))  # 2 minutes default
  (var result (wait_for_completion prompt_id timeout))

  # Extract output images - ComfyUI returns outputs keyed by node ID
  (var images [])

  (try
    (var outputs (safe_get result "outputs" {}))
    (var keys (outputs .keys))
    (keys .each (fn [node_id]
      (try
        (var node_output (outputs .get node_id))
        (if ((node_output != nil) && (node_output .contains "images"))
          (var node_images (safe_get node_output "images" []))
          (var i 0)
          (loop
            (if (i >= node_images/.size)
              (break)
            )
            (var img (node_images .get i))
            (if (img != nil)
              (var filename (safe_get img "filename" ""))
              (var subfolder (safe_get img "subfolder" ""))
              (var img_type (safe_get img "type" "output"))
              (images .append {
                ^filename filename
                ^subfolder subfolder
                ^type img_type
                # Proxy URL through backend - frontend doesn't need direct ComfyUI access
                ^url #"/api/image/view?filename=#{filename}&subfolder=#{subfolder}&type=#{img_type}"
                # Direct URL for debugging/admin use
                ^direct_url #"#{COMFYUI_URL}/view?filename=#{filename}&subfolder=#{subfolder}&type=#{img_type}"
              })
            )
            (i += 1)
          )
        )
      catch *
        nil
      )
    ))
  catch *
    nil
  )

  {
    ^prompt_id prompt_id
    ^images images
  }
)

# Health check for ComfyUI
(fn $ns/health_check []
  (try
    (var url #"#{COMFYUI_URL}/system_stats")
    (var resp_body (curl_get url))
    (var stats (gene/json/parse resp_body))
    {^status "ok" ^url COMFYUI_URL ^system stats/system}
  catch *
    {^status "error" ^message $ex/message}
  )
)
