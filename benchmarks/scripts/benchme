#!/usr/bin/env bash

# Usage:
# benchme|copy

echo "=== Gene Benchmark ==="
echo "Date: $(date '+%Y-%m-%d %H:%M:%S %A')"
echo "Git commit: $(git rev-parse HEAD)"
echo "Nim version: $(nim --version 2>&1 | head -1)"
echo

# Clean up old binary
rm -f bin/fibonacci 2>/dev/null

# Compile with modern memory management and suppress warnings
echo "Compiling fibonacci benchmark..."
CMD="nim c --hints:off --mm:orc -d:release -d:ssl --cpu:arm64 --out:bin/fibonacci benchmarks/computation/fibonacci.nim"
# Filter out warnings etc
$CMD 2>&1 | grep -v "arning:" | grep -v "ignoring duplicate libraries" | grep -v "instantiation" || true

# Run benchmark
echo
echo "Running benchmark..."
./bin/fibonacci "$@"

# Compile with modern memory management and suppress warnings
echo
echo
echo "Compiling fibonacci benchmark with JIT..."
CMD="nim c --hints:off --mm:orc -d:release -d:ssl --cpu:arm64 -d:geneJit --out:bin/fibonacci benchmarks/computation/fibonacci.nim"
# Filter out warnings etc
$CMD 2>&1 | grep -v "arning:" | grep -v "ignoring duplicate libraries" | grep -v "instantiation" || true

# Run benchmark
echo
echo "Running benchmark..."
./bin/fibonacci "$@"
